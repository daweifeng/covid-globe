<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>COVID-19 Global</title>
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <div id="container"></div>
  <h1>COVID-19 Confirmed Cases on July 4th 2020</h1>

  <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script>
  <script type="text/javascript" src="./lib/Detector.js"></script>
  <script type="text/javascript" src="./lib/three.min.js"></script>
  <script type="text/javascript" src="./lib/globe.js"></script>

  <script type="text/javascript">

    const container = document.querySelector("#container");
    const colorFunc = (x) => {
      const c = new THREE.Color();
      x = x * 200000
      
      // The more cases, the darken it is going to be
      c.setHSL( (1 - ((x-1)/(300000-10))) *0.20, 1, 0.5)
      return c
    }
    const opts = {
      imgDir: './',
      colorFn: colorFunc
    }
    const globe = new DAT.Globe(container, opts)

    fetch('07-04-2020.csv')
      .then(response => response.text())
      .then(csv => {
        const data = processCSV(csv)
        console.log(data)
        // Add data to globe
        for ( var i = 0; i < data.length; i ++ ) {
            globe.addData( data[i][1], {format: 'magnitude', name: data[i][0]} );
        }
        // Create the geometry
        globe.createPoints();
        // Begin animation
        globe.animate();
      })
      
    const processCSV = (csvFile) => {
      const allLines = csvFile.split(/\r\n|\n/)
      const headings = allLines[0].split(',')
      const date = moment(allLines[1].split(',')[4])
      console.log(date.format('LL'))
      const data = [['07-04-2020', []]]

      for (let i=1; i<allLines.length; i++) {
        const currentLine = allLines[i].split(',')
        const lat = currentLine[5]
        const long = currentLine[6]
        const confimedCases = currentLine[7]
        data[0][1] = data[0][1].concat([parseFloat(lat), parseFloat(long), confimedCases*0.000005])
      }
      return data
    }
    
  </script>
</body>
</html>